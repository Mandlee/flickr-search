/* flickr */
"use strict";var app=angular.module("app",["appRoutes","angular-loading-bar","ui.bootstrap"]);app.config(["$httpProvider","cfpLoadingBarProvider",function($httpProvider,cfpLoadingBarProvider){$httpProvider.defaults.useXDomain=!0,delete $httpProvider.defaults.headers.common["X-Requested-With"],$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",$httpProvider.interceptors.push("HttpInterceptor"),cfpLoadingBarProvider.includeSpinner=!1}]),app.run(["$rootScope",function($rootScope){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){})}]);var Config={BACKEND_URL:"https://api.flickr.com/services",API_KEY:"57f694132e4714c29a64c9af890b124e",development:!1,appName:"Flickr Search",version:"0.1 dev"};!function(){var host=window.location.hostname;(-1!==host.indexOf("localhost")||-1!==host.indexOf("127.0.0.1"))&&(Config.development=!0)}();var appRoutes=angular.module("appRoutes",["ui.router"]);appRoutes.config(function($stateProvider,$urlRouterProvider){$stateProvider.state("main",{url:"/main","abstract":!0,templateUrl:"view/main.html"}).state("main.home",{url:"/home",templateUrl:"view/pages/home.html"}).state("main.search",{url:"/search/{searchText}?tag",templateUrl:"view/pages/search.html",controller:"SearchController",controllerAs:"searchCtrl"}).state("main.photo",{url:"/photo/{id}",templateUrl:"view/pages/photo.html",controller:"PhotoController",controllerAs:"photoCtrl"}).state("main.about",{url:"/about",templateUrl:"view/pages/about.html"}),$urlRouterProvider.otherwise("/main/home")}),app.factory("HttpInterceptor",["$q","$location","$window","$rootScope",function($q,$location,$window,$rootScope){return{responseError:function(rejection){var status=rejection.status,isProduction=!(Config.development||401!==status&&403!==status&&status),isDevelopment=Config.development&&401===status;if(isProduction||isDevelopment){var params=$location.search();params.url=$location.path(),params.alert=403===status?"Forbidden":"",$rootScope.redirectParams=params}return $q.reject(rejection)}}}]),app.service("HttpService",["$http",function($http){this.get=function(uri,params){var url=Config.BACKEND_URL;return params.api_key=Config.API_KEY,params.format="json",params.nojsoncallback=1,"/"===uri.substr(1,1)&&(url="",uri=uri.substr(2)),$http.get(url+uri,{params:params})},this.post=function(uri,data){return $http.post(Config.BACKEND_URL+uri,$.param(data||{}))}}]),app.service("TagService",function(){var _activeTags=null,_tag=[{name:"Animals",icons:"./img/tags/animal.svg",subTag:[{name:"Pets",subTag:["Guppy","GoldFish","Dog","Cat"]},{name:"Wild animals",subTag:["Tiger","Ant","Tetra","Peafowl"]},{name:"Domestic animals",subTag:["Cow","Pig","Goat","Horse"]}]},{name:"Food",icons:"./img/tags/food.svg",subTag:[{name:"Fast Food",subTag:["Cheeseburger","Hamburger"]},{name:"Dessert",subTag:["Chocolate","Cookie","Cake","Pie"]}]},{name:"Vehicle",icons:"./img/tags/vehicle.svg",subTag:[{name:"Motorcycle",subTag:["Harley Davidson"]},{name:"Car",subTag:["Lamborghini","Ferrari","Bugatti","Mercedes","BMW"]}]},{name:"Movie",icons:"./img/tags/movie.svg",subTag:[{name:"Science fiction",subTag:["Sunshine","Interstellar","The Moon","Oblivion","Star Trek","Star Wars"]}]}],getAll=function(){return _tag},setTag=function(tag){_activeTags=tag},getTag=function(){return _activeTags};return{getAll:getAll,setTag:setTag,getTag:getTag}}),app.controller("MainController",["$scope","$state","TagService",function($scope,$state,TagService){var vm=this;vm.Config=Config,vm.getAllTag=TagService.getAll,$scope.isThisTabActive=function(tabState){return $state.current.name===tabState?"active":""};var _activeTag=null;vm.isActiveTag=function(tag){return null===_activeTag?!1:-1!==_activeTag.indexOf(tag)},vm.toggleTag=function(tag){if(_activeTag===tag)TagService.setTag(null),_activeTag=null;else{if(-1!==tag.indexOf("."))var _subTag=tag.slice(tag.lastIndexOf(".")+1,tag.length);TagService.setTag(_subTag||tag),_activeTag=tag}}}]),app.controller("SearchController",["$scope","$stateParams","HttpService","TagService",function($scope,$stateParams,HttpService,TagService){var vm=this;vm.actualPage=1,vm.searchText=$stateParams.searchText,$scope.refresh=function(){HttpService.get("/rest",{method:"flickr.photos.search",text:$stateParams.searchText,tags:$stateParams.tag,page:vm.actualPage}).success(function(data){$scope.results=data.photos,vm.totalPages=data.photos.total}).error(function(error){console.error(error)})},$scope.refresh()}]),app.controller("PhotoController",["$scope","$stateParams","HttpService","$state",function($scope,$stateParams,HttpService,$state){var vm=this;HttpService.get("/rest",{method:"flickr.photos.getInfo",photo_id:$stateParams.id}).success(function(data){$scope.picture=data.photo}).error(function(error){console.error(error)}),vm.selectTag=function(tag){$state.go("main.search",{tag:tag})}}]),app.directive("imgFlickr",function(){return{restrict:"E",scope:{picture:"=",size:"@"},templateUrl:"view/common/img_flickr.html"}}),app.directive("searchForm",["TagService","$state",function(TagService,$state){return{restrict:"E",scope:{params:"="},templateUrl:"view/common/search_form.html",link:function($scope,$element,$attr){$scope.text=$scope.params,$scope.search=function(){(""!==$scope.text||TagService.getTag())&&$state.go("main.search",{searchText:$scope.text,tag:TagService.getTag()})}}}}]);